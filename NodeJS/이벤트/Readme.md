# 자바스크립트 이벤트루프
![Nodejs 이벤트루프](https://image.toast.com/aaaadh/real/2018/techblog/Bt5ywJrIEAAKJQt.jpg)
- Node.js는 비동기 IO를 지원하기 위해 libuv 라이브러리를 사용하며, 이 libuv가 이벤트 루프를 제공한다. 
- 자바스크립트 엔진은 비동기 작업을 위해 Node.js의 API를 호출하며, 이때 넘겨진 콜백은 libuv의 이벤트 루프를 통해 스케쥴되고 실행된다.
- 자바스크립트가 '단일 스레드' 기반의 언어라는 말은 '자바스크립트 엔진이 단일 호출 스택을 사용한다'는 관점에서만 사실이다.
- 실제 자바스크립트가 구동되는 환경(브라우저, Node.js등)에서는 주로 여러 개의 스레드가 사용되며, 이러한 구동 환경이 단일 호출 스택을 사용하는 자바 스크립트 엔진과 상호 연동하기 위해 사용하는 장치가 바로 '이벤트 루프'인 것이다.
- 노드는 코드 맨 위에서부터 한줄 씩 실행합니다. 함수 호출 부분을 발견했다면 함수를 호출 스택에 넣는다. 호출 스택은 스택 개념으로 호출 순서와 반대로 실행 완료됩니다!

이벤트루프: 이벤트 발생 시, 호출할 콜백 함수들을 관리하고, 호출된 콜백 함수의 실행 순서를 결정하는 역할이며, 노드가 종료될 때까지 이벤트 처리를 위한 작업을 반복하므로, '루프'라고 부름 \
백그라운드: setTimeout 같은 타이머나 이벤트 리스너들이 대기하는 곳. 여러 작업이 동시 실행될 수 있다(음.. timeout 대기 100개 -> 동시에 백그라운드에 들어가서 대기 후 테스트큐에 동시에 전달인가?)\
테스트큐: 이벤트 발생 후, 백그라운드에서는 테스트 큐로 타이머나 이벤트 리스너의 콜백함수를 전달, 정해진 순서대로 콜백들이 줄을 서있어서 '콜백큐'로 불림, 보통은 완료된 순서대로 줄 서 있지만 특정한 경우에 순서가 바뀌기도 함.(특정한 경우?? -> 확인 필요)
        
```
function delay() {
    for (var i = 0; i < 100000; i++);
}
function foo() {
    delay();
    bar();
    console.log('foo!'); // (3)
}
function bar() {
    delay();
    console.log('bar!'); // (2)
}
function baz() {
    console.log('baz!'); // (4)
}

setTimeout(baz, 10); // (1)
foo();
```
결과: 'bar!' -> 'foo!' -> 'baz!\
![이벤트스택](https://image.toast.com/aaaadh/real/2018/techblog/46cb891a36d611e68728231d5bce2f36.png)\
전역 환경에서 실행되는 코드는 한 단위의 코드블록으로써 가상의 익명함수로 감싸져 있다고 생각하는 것이 좋다. \
따라서 위의 코드의 첫 줄이 실행될 때에 호출 스택의 맨 아래에 익명 함수가 하나 추가되며, 마지막 라인까지 실행되고 나서야 스택에서 제거된다. \

#블로킹과 논블로킹
블로킹: 이전 작업이 끝나야 다음 작업 진행 \
논브로킹: 이전 작업이 완료되지 않고 다음 작업을 진행

논블로킹 기법
- setTimeout(콜백, 0) -> html 4ms 지연, node 1ms 지연
- setImmediate

참고: 논 블로킹 방식으로 코드를 작성하여도, 직접 작성한 코드는 소요 시간이 짧아 지진 않는다. 서로 동시 시행되는게 아니라, 실행 순서만 바뀌는 것이기 때문이다.-> 실행 순서를 바꿔주는 관점에서 사용


** 출처
- [자바스크립트와 이벤트 루프](https://meetup.toast.com/posts/89)
- NodeJS 교과서 교재
